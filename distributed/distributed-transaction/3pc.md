---
description: 三阶段提交（3PC）是 两阶段提交（2PC） 的改进版本，主要解决 2PC 存在的“同步阻塞问题”和“协调者单点故障问题”。
---

# 3PC

## 1. 3PC 相比 2PC 的改进

| 协议      | 阻塞问题     | 单点故障              | 超时处理                               |
| ------- | -------- | ----------------- | ---------------------------------- |
| **2PC** | 存在同步阻塞   | 协调者崩溃可能导致事务悬挂     | 超时可能造成事务长时间锁定                      |
| **3PC** | **减少阻塞** | **引入超时机制，避免事务悬挂** | **引入 CanCommit 阶段，防止协调者崩溃导致事务不确定** |

***

### **3PC 核心改进**

1. **增加 “Can Commit” 阶段**，判断参与者是否准备好提交
2. **引入超时机制**，防止事务长时间占用资源
3. **协调者崩溃后**，参与者可以自主决定提交或回滚

## 2.三阶段提交的流程

### 第一阶段：Can Commit（询问阶段）

1. 协调者 向所有 参与者 发送 “是否可以提交” 请求
2. 参与者 检查事务是否可执行（资源是否可用等）
3. 参与者 返回

* Yes（可以提交）
* No（无法提交）

### 第二阶段：Prepare（准备阶段）

**（仅在所有参与者都返回 “Yes” 的情况下执行）**

1. 协调者 发送 “准备提交” 指令
2. 参与者 执行事务 但不提交，并记录日志
3. 参与者 返回 “已准备” 消息

❗ 如果超时未收到协调者指令，参与者 自动回滚



### 第三阶段：Commit（提交阶段）

**（仅在所有参与者都成功 Prepare 的情况下执行）**

1. 协调者 发送 “提交” 请求
2. 参与者 正式提交事务
3. 事务完成

❗ 如果协调者崩溃：

* 参与者超时后可以自行提交事务，减少 2PC 的阻塞问题

## 3.3PC 的优势

✅ 避免 2PC 的同步阻塞：

* 增加 CanCommit 阶段，判断事务是否可执行，避免资源长期锁定

✅ 参与者支持超时回滚：

* 如果协调者崩溃，参与者可以超时回滚，减少事务悬挂

✅ 高可用性：

* 协调者故障时，参与者可以自主决定提交或回滚

## 4.3PC 仍然存在的问题

❌ 数据不一致风险：

* 如果 提交阶段协调者崩溃，部分参与者提交，部分参与者未提交，可能导致数据不一致

❌ 网络分区问题：

* 在 网络分区（Partition）场景下，可能导致事务状态不同步，最终数据不一致

❌ 实现复杂度高：

* 需要引入 超时机制 和 协调者故障处理策略



## 5.适用场景

* 跨数据库事务：多个 MySQL、PostgreSQL、MongoDB 之间的数据一致性保障
* 分布式事务：电商、金融、支付系统 保障订单状态一致
* 微服务架构：微服务 A 需要调用 微服务 B、C，确保事务一致性



## 6. 3PC vs 2PC 对比总结

| 对比项       | **2PC （两阶段提交）** | **3PC （三阶段提交）**      |
| --------- | --------------- | -------------------- |
| **阶段**    | 2 个阶段           | 3 个阶段（多了 Can Commit） |
| **事务阻塞**  | ✅ 存在            | ❌ 避免阻塞               |
| **超时机制**  | ❌ 无             | ✅ 参与者超时可回滚           |
| **数据一致性** | ✅ 强一致性          | ❌ 可能存在数据不一致          |
| **协调者崩溃** | ❌ 事务悬挂          | ✅ 参与者可超时回滚           |
| **适用场景**  | 事务一致性要求高        | 高可用场景                |

***

## 7. 3PC 适合的应用场景

| 应用场景           | 适用性            |
| -------------- | -------------- |
| **高并发、高可用事务**  | ✅ 适合           |
| **强一致性（银行转账）** | ❌ 不适合（可能数据不一致） |
| **跨数据中心事务**    | ✅ 适合           |
| **分布式数据库**     | ✅ 适合           |
| **微服务事务**      | ✅ 适合           |



## 8. 3PC 的改进方案

### 🛠 Paxos / Raft 分布式共识协议

* ✅ 解决 3PC 数据不一致问题
* ✅ 适用于 **高可用性** 分布式存储

### 🛠 TCC (Try-Confirm-Cancel) 事务

* ✅ 适用于 **微服务**
* ✅ **比 3PC 更灵活**，不依赖数据库锁

### 🛠 GTM (Global Transaction Manager)

* ✅ **全球事务管理器**
* ✅ 适用于 **数据库分片、数据同步**

***

## 9. 重点总结

✅ **3PC 通过 "Can Commit" 阶段和超时回滚，减少 2PC 阻塞问题**\
✅ 适用于 **高可用 + 高并发 分布式事务场景**\
❌ **但可能导致数据不一致**，特别是在**网络分区**情况下\
✅ 适用于 **微服务、分布式数据库、电商、支付系统**，但对**强一致性要求高**的场景仍需 **Paxos / Raft!**





