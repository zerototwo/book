# MySQL 事务的 一致性 (Consistency) 实现原理

## **📌 1. 什么是一致性 (Consistency)?**

一致性 (Consistency) 指的是 **事务执行前后，数据库必须处于一致状态，不会出现数据丢失或错误**。

### **✅ 一致性要求**

1. **数据必须满足完整性约束**（主键、外键、唯一约束等）。
2. **事务执行后，数据不会出现逻辑错误**（例如转账后，账户总余额应保持不变）。
3. **事务失败时，数据库状态必须回滚到事务开始前的状态**。

***

## **📌 2. MySQL 如何实现一致性？**

MySQL 主要通过以下方式 **保证事务的一致性**：

1. **事务日志**：
   * **Undo Log（回滚日志）**：回滚事务，撤销已执行的 SQL 操作，确保数据一致。
   * **Redo Log（重做日志）**：保证事务提交后，即使崩溃也能恢复数据。
2. **完整性约束**：
   * **主键 (Primary Key)** 确保每行数据唯一。
   * **外键 (Foreign Key)** 维持数据之间的正确关系。
   * **唯一索引 (Unique Index)** 确保特定列的值唯一。
3. **事务回滚 (ROLLBACK)**：
   * 遇到异常或错误时，MySQL 可以使用 **Undo Log** 进行回滚，恢复数据。

***

## **📌 3. 一致性的详细实现**

### **🔹 1. 事务日志**

**✅ Undo Log（回滚日志）**

* 作用：**记录事务执行前的数据状态**，用于回滚事务，保证数据一致性。
* 工作原理：
  * **修改前**：Undo Log 记录数据的旧值。
  * **事务提交**：Undo Log 可被清理（回收）。
  * **事务回滚**：Undo Log 用于撤销修改。

**✅ Redo Log（重做日志）**

* 作用：**记录事务提交后的数据变化**，用于数据库崩溃后恢复数据，确保一致性。
* 工作原理：
  * **事务提交前**，先写入 **Redo Log**。
  * **系统崩溃时**，Redo Log 重新应用事务，恢复数据。

***

### **🔹 2. 数据完整性约束**

MySQL 通过以下 **约束机制** 保障事务一致性：

| **约束类型**                | **作用**           |
| ----------------------- | ---------------- |
| **主键 (Primary Key)**    | 确保每行数据唯一         |
| **外键 (Foreign Key)**    | 维持数据完整性，避免“孤立数据” |
| **唯一索引 (Unique Index)** | 约束某列数据不可重复       |
| **检查约束 (CHECK)**        | 限制字段取值范围         |
| **非空约束 (NOT NULL)**     | 确保字段不能为空         |

#### **📝 示例**

```sql
CREATE TABLE accounts (
    id INT PRIMARY KEY AUTO_INCREMENT,
    user_id INT NOT NULL,
    balance DECIMAL(10,2) NOT NULL CHECK (balance >= 0),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

* CHECK(balance >= 0)：确保 balance 不能为负数。
* FOREIGN KEY 约束 user\_id 必须存在于 users 表中，避免孤立数据。

***

### 🔹 3. 事务回滚 (ROLLBACK)

当事务执行失败时，MySQL 使用 Undo Log 进行回滚，确保数据库回到事务前的状态。

#### 📝 示例

```sql
START TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;
ROLLBACK; -- 事务失败，撤销所有修改
```

🔹 事务回滚后，balance 仍然保持不变，确保数据一致性。

## 📌 4. 一致性应用场景

| 操作类型       | 事务提交后 | 事务回滚后 |
| ---------- | ----- | ----- |
| **INSERT** | 记录保留  | 记录被删除 |
| **UPDATE** | 变更生效  | 变更回滚  |
| **DELETE** | 记录删除  | 记录恢复  |

## 📌 5. MySQL 一致性实现总结

| **一致性机制**               | **作用**           |
| ----------------------- | ---------------- |
| **Undo Log（回滚日志）**      | 事务失败时撤销操作，保持数据一致 |
| **Redo Log（重做日志）**      | 事务提交后，即使崩溃也能恢复数据 |
| **完整性约束（PK、FK、UNIQUE）** | 确保数据符合业务逻辑       |
| **事务回滚（ROLLBACK）**      | 遇到异常时撤销所有操作      |

## 结论

* 一致性保证事务前后数据库状态合法，符合完整性约束。
* Undo Log 允许事务回滚，确保数据一致性。
* Redo Log 保障事务提交后，即使宕机也能恢复数据。
* 事务失败时，数据库必须回滚到事务开始前的状态，避免数据部分提交导致的不一致问题。



