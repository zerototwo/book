# MySQL 事务的 原子性 (Atomicity) 实现原理

## **📌 1. 什么是原子性 (Atomicity)?**

原子性 (Atomicity) 指的是 **事务中的所有操作要么全部成功，要么全部失败，不会只执行一部分**。\
如果事务执行过程中发生错误，所有已执行的操作都必须被撤销，保证数据库不会出现部分更新的数据。

***

## **📌 2. MySQL 如何实现原子性？**

MySQL 通过 **Undo Log (回滚日志) 机制** 来实现 **事务的原子性**。\
Undo Log 记录事务执行前的数据快照，确保事务在失败或回滚时可以撤销已执行的操作。

***

## **📌 3. Undo Log 机制**

## **🔹 Undo Log 是什么？**

* **Undo Log (回滚日志)** 主要用于存储 **事务执行前的数据快照**。
* 当事务执行 **INSERT、UPDATE、DELETE** 操作时，MySQL 会自动生成 Undo Log 记录事务前的数据。
* 如果事务回滚，MySQL 会利用 Undo Log 恢复数据，确保事务的一致性。

### **✅ Undo Log 工作流程**

1. **事务开始**：
   * 创建 Undo Log 记录事务前的数据状态。
2. **事务执行**：
   * `INSERT`：删除记录。
   * `UPDATE`：修改回原值。
   * `DELETE`：重新插入被删除的行。
3. **事务提交**：
   * 正常提交：Undo Log 失效，可被清理（Purged）。
   * 事务回滚：利用 Undo Log 进行回滚操作，撤销所有修改。

***

## **📌 4. Undo Log 实现事务回滚**

### **📝 示例**

```sql
START TRANSACTION;
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
ROLLBACK; -- 回滚事务，撤销所有修改
```

## 📌 5. Undo Log 的存储

Undo Log 主要存储在 回滚段 (Rollback Segment)，并 支持 MVCC (多版本并发控制)，允许事务读取旧版本数据。

当事务提交后，Undo Log 会被标记为 可清理 (Purge)，由后台线程清理，减少存储占用。

## 📌 6. MySQL 原子性的应用场景

| 操作类型       | 事务提交后 | 事务回滚后 |
| ---------- | ----- | ----- |
| **INSERT** | 记录保留  | 记录被删除 |
| **UPDATE** | 变更生效  | 变更回滚  |
| **DELETE** | 记录删除  | 记录恢复  |

## 7.结论

* 原子性 (Atomicity) 确保事务要么全部成功，要么全部失败，不会出现部分提交的情况。
* Undo Log (回滚日志) 机制记录数据修改前的状态，在事务失败或回滚时撤销所有更改。
* Undo Log 结合 MVCC（多版本并发控制），允许事务读取旧版本数据，提高并发能力。
* 事务提交后，Undo Log 逐步被清理，减少数据库存储压力。

